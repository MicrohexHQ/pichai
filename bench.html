<!--Test bench code for webduino.
    
    This file is part of webduino.
    
    webduino is free software; you can redistribute it and/or modify it under
    the terms of the GNU General Public License as published by the Free
    Software Foundation; either version 3, or (at your option) any later
    version.
    
    webduino is distributed in the hope that it will be useful, but WITHOUT ANY
    WARRANTY; without even the implied warranty of MERCHANTABILITY or
    FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
    for more details.
    
    You should have received a copy of the GNU General Public License
    along with webduino; see the file LICENSE.  If not see
    <http://www.gnu.org/licenses/>-->
<html>  
    <script type="text/javascript" src="js/avrcore.js"></script>
    <div>
    Intel Hex File <input type="file" id="hexfile"/>
    Disassembly File <input name="debug" type="file" id="debugfile"/>
    <br/>
    <span class="loadMemory">
      <button>Load Memory</button>
    </span>
    <button onClick="exec()">Continue</button>
    </div>
    <br/>
    <div style="width: 25%; display: table;">
        <div style="display: table-row">
            <div style="display: table-cell;">  <canvas id="led0" width="10" height="10"/> </div>
            <div style="display: table-cell;">  <canvas id="led1" width="10" height="10"/> </div>
            <div style="display: table-cell;">  <canvas id="led2" width="10" height="10"/> </div>
            <div style="display: table-cell;">  <canvas id="led3" width="10" height="10"/> </div>
            <div style="display: table-cell;">  <canvas id="led4" width="10" height="10"/> </div>
            <div style="display: table-cell;">  <canvas id="led5" width="10" height="10"/> </div>
            <div style="display: table-cell;">  <canvas id="led6" width="10" height="10"/> </div>
            <div style="display: table-cell;">  <canvas id="led7" width="10" height="10"/> </div>
        </div>
    </div>
    <br/>
    <select id = "breakpoints"></select>
    <br/>
    <textarea id="disassembly" name="outputtext" rows="100" cols="90"></textarea>
    <script>
      fillLED("led0", "#FF0000");
      fillLED("led1", "#FF0000");
      fillLED("led2", "#FF0000");
      fillLED("led3", "#FF0000");
      fillLED("led4", "#FF0000");
      fillLED("led5", "#FF0000");
      fillLED("led6", "#FF0000");
      fillLED("led7", "#FF0000");
      
      var cachedDisassembly;
      var pointsPerLine = 16;
      
      function matchTextToBreakpoint(text, address) {
         var start = 0;
         var lineCount = 0;
         while(start >= 0 && start < text.length){
            start = text.indexOf('\n', start)+1;
            if(text.substring(start).indexOf(address) != -1)
                lineCount++;
         }
         return pointsPerLine*lineCount;
      }
      
      function getAddressString(address){
        return " "+(parseInt(address, 16) - flashStart).toString(16)+":"          
      }
      
      function handleBreakpoint(address){
        var addressString = getAddressString(address);
        var textarea = document.getElementById('disassembly');
        textarea.value = cachedDisassembly;
        var retVal = 
            matchTextToBreakpoint(
                cachedDisassembly, 
                addressString
            ); 
        textarea.scrollTop = retVal;
        var line = (retVal/pointsPerLine);
        var limit = (textarea.scrollTop/pointsPerLine);
        if(line > limit){
           textarea.value = cachedDisassembly.substring(cachedDisassembly.indexOf(addressString));
        }
      }
      
      function checkBreakpoint(address){
        if(matchTextToBreakpoint(cachedDisassembly, address) > 0){
            var option = document.createElement("OPTION");
            option.appendChild(document.createTextNode(address));
            document.getElementById("breakpoints").appendChild(option);
            
            return true;
        }
        
        return false;
      }
      
      function initializeBreakpoints(){
          var skips = 0;
          var endPoint = (matchTextToBreakpoint(cachedDisassembly, "__stop_program")/16);
          for(i = 0; i < endPoint; i++){
            var address = getAddressString((flashStart+(i*2)).toString(16));
            if(!checkBreakpoint(address)){
                skips++;
            }
          }
          for(i = endPoint; i < endPoint+skips; i++){
              var address = getAddressString((flashStart+(i*2)).toString(16));
              checkBreakpoint(address);             
          }
      }
      
      document.querySelector('.loadMemory').addEventListener('click', function(evt) {
        var file = document.getElementById('hexfile').files[0];
        var debugfile = document.getElementById('debugfile').files[0];
        if (!file) {
          alert('Intel Hex File Required');
          return;
        }
        var textarea = document.getElementById('disassembly');
        if (!debugfile) {
          textarea.value = "No debug file selected";
        }else{
            var reader = new FileReader();
            reader.onloadend = function(evt) {
              if (evt.target.readyState == FileReader.DONE)
                 textarea.value = evt.target.result;
                 cachedDisassembly = textarea.value;
                 initializeBreakpoints();
            };
            reader.readAsBinaryString(debugfile.slice(0, debugfile.size));
        }  
  
        var reader = new FileReader();
        reader.onloadend = function(evt) {
          if (evt.target.readyState == FileReader.DONE) {
              loadMemory(evt.target.result);
              engineInit();
              exec();
          }
        };
    
        reader.readAsBinaryString(file.slice(0, file.size));
      }, false);
    </script>
</html>
